[TODO] há sitios com id ou id_user que podem ter username

# eBaw

O eBaw é uma plataforma online de compras e vendas, sob a forma de leilões ou de venda normal com preço fixo, de todo o tipo de produtos.

# A9: Principais acessos à base de dados e transações

Este artefato mostra os principais acessos à base de dados, incluindo as transações. Para cada transação, o nível de isolamento deve ser explicitamente declarado e as transações somente de leitura devem ser identificadas para melhorar o desempenho global. Para cada acesso identificado, o código SQL e a referência de recursos _web_ (A7) devem ser apresentados. Um determinado acesso ao banco de dados pode ser usado em mais de um recurso.

## 1. Acessos Principais

| Referência | Descrição |
|------|------|
| [M01](#M01) | Módulo 1 - Módulo de autenticação |
| [M02](#M02) | Módulo 2 - Módulo de utilizador |
| [M03](#M03) | Módulo 3 - Módulo de produto |
| [M04](#M04) | Módulo 4 - Módulo de administração |
| [M05](#M05) | Módulo 5 - Módulo do público em geral |

### 1.1 <a name="M01">M01: Autenticação</a>

| Acesso | Descrição |
| ------ | --------- |
| [SQL101](#SQL101) | Criar um novo utilizador          |
| [SQL102](#SQL102) |  Autenticar um _authenticated_          |
| [SQL103](#SQL103) | Autenticar um administrador          |
| [SQL104](#SQL104) |  Verificar se um email pertence a algum member (para recuperar credenciais)         |
| [SQL105](#SQL105) | Ir buscar a cidade a partir do código postal          |


| **<a name="SQL101">SQL101</a>**  | Criar um novo utilizador |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R105](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R105) |
| Código SQL completo | INSERT INTO "user" (name, username, hashed_pass, email, phone_number, address, cod_postal, birth_date, register_date, state_user) VALUES (concat($primeiro_nome,$ultimo_nome), $username, hash($password1), $email, $phone_number, $address, $cod_postal, $birth_date, current_timestamp, 'active'); |


| **<a name="SQL102">SQL102</a>**  | Autenticar um _authenticated_ |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R106](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R106) |
| Código SQL completo | SELECT username FROM authenticated WHERE username = $username AND password = hash($password); |


| **<a name="SQL103">SQL103</a>**  | Autenticar um administrador |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R106](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R106) |
| Código SQL completo | SELECT username FROM admin WHERE username = $username AND password = hash($password); |

| **<a name="SQL104">SQL104</a>**  | Verificar se um email pertence a algum member (para recuperar credenciais) |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R107](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R107) |
| Código SQL completo | SELECT username,password FROM authenticated WHERE email = $email UNION SELECT username,password FROM admin WHERE email = $email; |

| **<a name="SQL105">SQL105</a>**  | Ir buscar a cidade a partir do código postal |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R101](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R101) |
| Código SQL completo | SELECT city_name from city JOIN postal ON city.id_city = postal.id_city WHERE postal_code = $cod_postal; |


### 1.2 <a name="M01">M02: Utilizador</a>

| Acesso | Descrição |
| ------ | --------- |
| [SQL201](#SQL201) | Mostrar dados do próprio perfil |
| [SQL202](#SQL202) | Mostrar dados do perfil de outro _authenticated_ |
| [SQL203](#SQL203)       | Editar o perfil          |
| [SQL204](#SQL204)       | Ir buscar as notificações de um _authenticated_         |
| [SQL205](#SQL205)       | Marcar notificação como lida          |
| [SQL206](#SQL206)       | Histórico de Produtos Colocados à Venda          |
| [SQL207](#SQL207)       | Histórico de Compras e Vendas Concluidas |
| [SQL208](#SQL208)       | Histórico de Licitações |
| [SQL209](#SQL209)       | Histórico de Notificações |
| [SQL210](#SQL210)       | Histórico de Comentários |
| [SQL211](#SQL211)       | Procurar Users |       |
| [SQL212](#SQL212)       | Denunciar um _authenticated_          |
| [SQL213](#SQL213)       | Ir buscar as notificações mais recentes |
| [SQL214](#SQL214)       | Cancelar Conta |


| **<a name="SQL201">SQL201</a>** | Mostrar dados do próprio perfil |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R201](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R201) |
| Código SQL completo | SELECT \* FROM authenticated WHERE username = $username; | 

| **<a name="SQL202">SQL202</a>** | Mostrar dados do perfil de outro _authenticated_ |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R201](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R201) |
| Código SQL completo | SELECT email,photo,totalVotes,description FROM authenticated WHERE username = $username; | 

| **<a name="SQL203">SQL203</a>**  | Editar o perfil |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R205](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R205) |
| Código SQL completo | UPDATE authenticated SET name = $name, email = $email, address = $address, cod_postal = $cod_postal, phone_number = $phone_number, password = $password1, photo = $photo WHERE username = $username; |


| **<a name="SQL204">SQL204</a>** | Ir buscar as notificações de um _authenticated_ |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R203](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R203) |
| Código SQL completo | SELECT \* FROM notification WHERE id_user = $id GROUP BY is_new, id_notif ORDER BY DATE DESC; |

| **<a name="SQL205">SQL205</a>**  | Marcar notificação como lida |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R203](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R203) |
| Código SQL completo | UPDATE notification SET is_new = "false" WHERE id_notif = $id_notif; |


| **<a name="SQL206">SQL206</a>**  | Histórico de Produtos colocados à Venda |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R203](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R203) |
| Código SQL completo | SELECT \* FROM product WHERE id_owner = $id |

| **<a name="SQL207">SQL207</a>**  | Histórico de Compras e Vendas Concluidas |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R203](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R203) |
| Código SQL completo | SELECT \* FROM transaction WHERE id_buyer = $id OR id_seller = $id; |


| **<a name="SQL208">SQL208</a>**  | Histórico de Licitações |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R203](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R203) |
| Código SQL completo | SELECT \* FROM bidding WHERE id_bidder = $id; |

| **<a name="SQL209">SQL209</a>**  | Histórico de Notificações |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R203](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R203) |
| Código SQL completo | SELECT \* FROM notification WHERE id_user = $id; |

| **<a name="SQL210">SQL210</a>**  | Histórico de Comentários |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R203](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R203) |
| Código SQL completo | SELECT \* FROM comment WHERE id_commenter = $id; |


| **<a name="SQL211">SQL211</a>**  | Procurar Users |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R207](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R207) |
| Código SQL completo | SELECT username, email, photo, total_votes, description FROM authenticated WHERE username = $username AND id != $id;|
 


| **<a name="SQL212">SQL212</a>**  | Denunciar um _authenticated_ |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R206](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R206) |
| Código SQL completo | WITH produto AS (INSERT INTO report (state_report, date_report, reason, text_report) VALUES ('assume',  current_timestamp, "", $text_report) returning id) INSERT INTO report_authenticated (id_user,id_reporter,id_report) VALUES ($id, $id_reporter, (select id from produto)); |


| **<a name="SQL213">SQL213</a>**  | Ir buscar as notificações mais recentes |
| ------------- | ------------------------------------------- |
| Recurso _web_ | Este acesso é usado em todos os recursos _web_ dos módulos M02, M03 e M04 bem como no módulo M05 se o membro estiver autenticado. |
| Código SQL completo |  SELECT \* FROM notification WHERE id_user =$id AND is_new = TRUE ORDER BY bidding.bidding_date DESC LIMIT 5; |


| **<a name="SQL214">SQL214</a>**  | Cancelar conta |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R208](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R208) |
| Código SQL completo | UPDATE authenticated SET state_user = "inactive" WHERE id = $id; |

<!--
SQL206 Get user's active auctions 
SELECT product.name, (
SELECT image.filename
FROM image
WHERE image.product_id = product.id
LIMIT 1
) AS image, product.description, auction.curr_bid, auction.end_date - now()
AS remaining_time
FROM auction
JOIN product ON auction.product_id = product.id
JOIN "user" ON auction.user_id = "user".id
WHERE now() < auction.end_date
AND "user".id = :user_id

SQL207 Get user's reviews 
SELECT review.rating, buyer.id AS reviewer_id, buyer.username AS
reviewer_username, review.date, product.name AS product_name,
review.message, auction.id AS auction_id,
(SELECT image.filename
FROM image
WHERE product.id = image.product_id
LIMIT 1 ) AS image_filename
FROM review
INNER JOIN bid ON review.bid_id = bid.id
INNER JOIN auction ON bid.auction_id = auction.id
INNER JOIN "user" buyer ON bid.user_id = buyer.id
INNER JOIN product ON auction.product_id = product.id
INNER JOIN "user" seller ON auction.user_id = seller.id
WHERE seller.id = :user_id

SQL208 Get user's wins 
SELECT product.name AS product_name, product.description, auction.id AS
auction_id, auction.start_bid, auction.curr_bid, auction.end_date,
seller.username AS seller_username, seller.id AS seller_id, bid.id AS
bid_id,
(SELECT image.filename
FROM image
WHERE product.id = image.product_id
LIMIT 1 ) AS image_filename
FROM auction
JOIN product ON auction.product_id = product.id
JOIN bid ON auction.id = bid.auction_id
AND auction.curr_bid = bid.amount
JOIN "user" winner ON bid.user_id = winner.id
JOIN "user" seller ON auction.user_id = seller.id
WHERE now() > auction.end_date
AND winner.id = :user_id

SQL209 Get following users 
SELECT us1.id, us1.profile_pic, us1.name, us1.username
FROM follow
INNER JOIN "user" us1 ON follow.user_followed_id = us1.id
INNER JOIN "user" us2 ON follow.user_following_id = us2.id
WHERE us2.id = :following_user_id


SQL211 Get last 2 user's bids 
SELECT bid.amount, auction.id AS auction_id, bid.date, seller.id AS
seller_id, seller.username AS seller_username
FROM bid
INNER JOIN "user" own ON bid.user_id = own.id
JOIN auction ON bid.auction_id = auction.id
JOIN "user" seller ON auction.user_id = seller.id
WHERE own.id = :user_id
ORDER BY bid.date
LIMIT 2


SQL212 Get the last 2 wins 
SELECT auction.end_date, seller.username AS seller_username, auction.id AS
auction_id, seller.id AS seller_id
FROM auction
JOIN bid ON auction.id = bid.auction_id AND auction.curr_bid = bid.amount
JOIN "user" winner ON bid.user_id = winner.id
JOIN "user" seller ON auction.user_id = seller.id
WHERE now() > auction.end_date
AND winner.id = :user_id
ORDER BY auction.end_date DESC
LIMIT 2

SQL213 Get the last 2 question posted by the user
SELECT own.username AS own_username, question.id AS question_id, auction.id
AS auction_id, seller.username AS seller_username, question.date
FROM question
JOIN "user" own ON question.user_id = own.id
JOIN auction ON question.auction_id = auction.id
JOIN "user" seller ON auction.user_id = seller.id
WHERE own.id = :user_id
ORDER BY question.date DESC
LIMIT 2

SQL214 Get the last 2 added auctions on the watchlist 
SELECT "user".username, auction.id, product.name, watchlist.date
FROM watchlist
JOIN "user" ON watchlist.user_id = "user".id
JOIN auction ON watchlist.auction_id = auction.id
JOIN product ON auction.product_id = product.id
WHERE "user".id = :user_id
ORDER BY watchlist.date DESC
LIMIT 2

SQL216 Insert review 
INSERT INTO review (rating, message, DATE, bid_id)
VALUES (:rating, :message, now(), :bid_id)

SQL218 Update user's details
UPDATE "user"
SET name = :real_name,
short_bio = :small_bio,
email = :email,
phone = :phone,
full_bio = :full_bio
WHERE id = :user_id
-->
 
### 1.3 <a name="M03">M03: Produto</a>

| Acesso | Descrição |
| ------ | --------- |
| [SQL301](#SQL301) | Obter Produtos de uma categoria |
| [SQL302](#SQL302) | Obter Todos os Produtos |
| [SQL303](#SQL303)       | Obter Produto    |
| [SQL304](#SQL304)       | Criar um Novo Produto de Leilão |
| [SQL305](#SQL305)       | Criar um Novo Produto de _buy_it_now_      |
| [SQL306](#SQL306)       | Editar um Produto de Leilão |
| [SQL307](#SQL307)       | Editar um Produto de  _buy_it_now_ |
| [SQL308](#SQL308)       | Obter Todos os Produtos com filtros |
| [SQL309](#SQL309)       | Adicionar um comentário |
| [SQL310](#SQL310)       | Denunciar um comentário    |
| [SQL311](#SQL311)       | Licitar no Produto         |
| [SQL312](#SQL312)       | Comprar o Produto |
| [SQL313](#SQL313)       | Cancelar o Produto |
| [SQL314](#SQL314)       | Avaliar Comprador (Transação) |
| [SQL315](#SQL315)       | Avaliar Vendedor (Transação) |
| [SQL316](#SQL316)       | Denunciar Produto  |
| [SQL317](#SQL317)       | Pesquisar Produtos |


| **<a name="SQL301">SQL301</a>**  | Obter Produtos ativos de uma categoria |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R306](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R306) |
| Código SQL completo | SELECT * FROM product LEFT JOIN auction on id_auction = id_product LEFT JOIN buy_it_now ON id_product = id_buy WHERE category=$categoria AND state_product = 'active' AND (current_timestamp<buy_it_now.date_end OR current_timestamp<auction.date_end_auction);  |


| **<a name="SQL302">SQL302</a>**  | Obter Todos os Produtos ativos |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R312](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R312) |
| Código SQL completo | SELECT * FROM product LEFT JOIN auction on id_auction = id_product LEFT JOIN buy_it_now ON id_product = id_buy WHERE state_product = 'active' AND (current_timestamp<buy_it_now.date_end OR current_timestamp<auction.date_end_auction); |

| **<a name="SQL303">SQL303</a>**  | Obter Produto |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R301](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R301) |
| Código SQL completo | SELECT * FROM product JOIN authenticated ON product.id_owner = authenticated.id LEFT JOIN auction on id_auction = id_product LEFT JOIN buy_it_now ON id_product = id_buy WHERE id_product = $id_product; |


| **<a name="SQL304">SQL304</a>**  | Criar um Novo Produto de Leilão |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R304](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R304) |
| Código SQL completo | WITH produto AS INSERT INTO product (name, category, foto, is_new, description, sale_type, date_placement) VALUES ($name, $category, $foto, $is_new, $description, $sale_type, current_timestamp) RETURNING id_product) INSERT INTO auction VALUES (produto.id_product, $date_end, $bidding_base, $bidding_base); |

| **<a name="SQL305">SQL305</a>**  | Criar um Novo Produto de buy_it_now |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R304](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R304) |
| Código SQL completo | WITH produto AS INSERT INTO product (name, category, foto, is_new, description, sale_type, date_placement) VALUES ($name, $category, $foto, $is_new, $description, $sale_type, current_timestamp) RETURNING id_product) INSERT INTO buy_it_now VALUES (produto.id_product, $date_end, $final_value); |


| **<a name="SQL306">SQL306</a>**  | Editar um Produto de Leilão |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R305](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R305) |
| Código SQL completo | UPDATE product SET name = $name, category = $category, foto = $foto, is_new = $is_new, description = $description, sale_type = $sale_type WHERE id_product = $id_product; UPDATE auction SET date_end = $date_end WHERE id_auction = $id_product; |

| **<a name="SQL307">SQL307</a>**  | Editar um Produto de  buy_it_now |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R305](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R305) |
| Código SQL completo | UPDATE product SET name = $name, category = $category, foto = $foto, is_new = $is_new, description = $description, sale_type = $sale_type WHERE id_product = $id_product; UPDATE buy_it_now SET date_end = $date_end, final_value = $final_value WHERE id_buy = $id_product; |

| **<a name="SQL308">SQL308</a>**  | Obter Todos os Produtos com filtros |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R312](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R312) |
| Código SQL completo | SELECT * FROM product LEFT JOIN auction on id_auction = id_product LEFT JOIN buy_it_now ON id_product = id_buy WHERE category=$category AND ($min_price <= auction.highest_value OR  $min_price <= buy.it.now.final_value) AND ($max_price >= auction.highest_value OR $min_price <= buy.it.now.final_value) AND CURRENT_TIMESTAMP - INTERVAL('$days days' ) >= date_placement AND state_product = 'active' AND (current_timestamp<buy_it_now.date_end OR current_timestamp<auction.date_end_auction); |

<!-- CREATE VIEW FTSquery AS SELECT \*, ts_rank(name_product,description) AS rank FROM product WHERE search @@ tsquery('?') ORDER BY rank; [TODO] -->


| **<a name="SQL309">SQL309</a>**  | Adicionar um comentário |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R307](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R307) |
| Código SQL completo | INSERT INTO comment (id_commenter, id_product, date_comment, msg_ofComment) VALUES ($id_commenter, $id_product, current_timestamp, $msg_ofComment); |

| **<a name="SQL310">SQL310</a>**  | Denunciar um comentário |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R308](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R308) |
| Código SQL completo | WITH produto AS (INSERT INTO report (state_report, date_report, reason, text_report) VALUES ('assume',  current_timestamp, "", $text_report) returning id) INSERT INTO report_comment (id_comment,id_reporter,id_report) VALUES ($id_comment, $id_reporter, (select id from produto)); |

| **<a name="SQL311">SQL311</a>**  | Licitar no Produto |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R309](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R309) |
| Código SQL completo | INSERT INTO bidding (bidder, value_bid, bidding_date) VALUES ($bidder, $value_bid, current_timestamp) WHERE id_auction = $id_product; |

| **<a name="SQL312">SQL312</a>**  | Comprar o Produto |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R310](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R310) |
| Código SQL completo | INSERT INTO transaction (id_buyer, id_seller , id_product, value) VALUES ($id_user, (SELECT id_owner FROM product LEFT JOIN buy_it_now ON id_buy = id_product WHERE id_product = $id_product;), $id_product, (SELECT final_value FROM product LEFT JOIN buy_it_now ON id_buy = id_product WHERE id_product = $id_product;)); |

| **<a name="SQL313">SQL313</a>**  | Cancelar o Produto |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R311](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R311) |
| Código SQL completo | UPDATE product SET state_product = 'inactive' WHERE id_product = $id_product; |

| **<a name="SQL314">SQL314</a>**  | Avaliar Comprador (transação) |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R314](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R314) |
| Código SQL completo | UPDATE transaction SET votes_in_buyer = $vote WHERE id_product = $id_product; |

| **<a name="SQL315">SQL315</a>**  | Avaliar Vendedor (Transação) |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R314](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R314) |
| Código SQL completo | UPDATE transaction SET votes_in_seller = $vote WHERE id_product = $id_product; |

| **<a name="SQL316">SQL316</a>**  | Denunciar Produto |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R315](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R315) |
| Código SQL completo | WITH produto AS (INSERT INTO report (state_report, date_report, reason, text_report) VALUES ('assume',  current_timestamp, "", $text_report) returning id) INSERT INTO report_product (id_product,id_reporter,id_report) VALUES ($id_product, $id_reporter, (select id from produto)); |

| **<a name="SQL317">SQL317</a>**  | Pesquisar Produtos |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R313](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R313) |
| Código SQL completo | SELECT \*, ts_rank(name_product,description) AS rank FROM product WHERE search @@ tsquery('$search') ORDER BY rank; |

<!--
SQL301 What are the last 5 bids of an auction?
SELECT "user".username, bid.amount, bid.date
FROM auction
INNER JOIN bid ON auction.id = bid.auction_id
INNER JOIN "user" ON bid.user_id = "user".id
WHERE auction.id =?
ORDER BY bid.date DESC
LIMIT 5 ;

SQL304 Bid on the auction 
INSERT INTO bid (amount, DATE, user_id, auction_id)
VALUES (:amount_bid, now(), :user_id, :auction_id);

SQL305 Get auction questions 
SELECT question.*, "user".username
FROM question
INNER JOIN "user" ON "user".id = question.user_id
WHERE auction_id = ?;

SQL306 Create a question 
INSERT INTO question (DATE, message, auction_id, user_id) VALUES (now(), ?,
?, ?);


SQL308 Create auction 
INSERT INTO auction (start_bid, curr_bid, start_date, end_date, TYPE,
user_id, product_id, DATE) VALUES (?, ?, ?, ?, ?, ?, ?, now());

SQL309 Add image to an auction 
INSERT INTO image (filename, product_id, description) VALUES (?, ?, ?)

SQL310 Get all categories. R402, R401, 
SELECT unnest(enum_range(NULL::category_type))::text;

SQL315 Search auctions by name. 
SELECT auction.id, product.name AS product_name, product.description,
"user".username,
"user".rating AS user_rating, auction.curr_bid, auction.end_date,
"user".id AS user_id, ts_rank_cd(textsearch, query) AS rank
FROM auction, product, "user",
plainto_tsquery('english', :textSearch) AS query,
to_tsvector('english', product.name || ' ' || product.description) AS
textsearch
WHERE auction.product_id = product.id AND query @@ textsearch
AND now() < auction.end_date
AND auction.user_id = "user".id
ORDER BY rank DESC;
 
SQL316 Search auctions by date, price and category. 
SELECT auction.id, product.name AS product_name, product.description,
"user".username, "user".rating AS user_rating, auction.curr_bid,
auction.end_date, "user".id AS user_id
FROM auction, product, "user"
WHERE auction.product_id = product.id AND auction.user_id = "user".id AND
:fromDate < auction.end_date AND auction.end_date < :toDate AND
auction.curr_bid >= :fromPrice AND auction.curr_bid <= :toPrice AND
:category = ANY(product.type);

SQL323 What is the image of an auction? R401, 
SELECT image.*
FROM image
JOIN product ON image.product_id = product.id
JOIN auction ON product.id = auction.product_id
WHERE auction.id =?
LIMIT 1 ;
-->











<!--
SQL302 How many bids were made in a certain auction?
SELECT COUNT(*)
FROM bid
JOIN auction ON bid.auction_id = auction.id
WHERE auction.id = ?;

SQL303 How many reviews does the seller has? 
SELECT COUNT(*)
FROM review
INNER JOIN bid ON review.bid_id = bid.id
INNER JOIN auction ON bid.auction_id = auction.id
INNER JOIN "user" ON auction.user_id = "user".id
WHERE "user".id = ?;

SQL304 Get similar auctions to a given auction R
SELECT similarAuction.id, similarProduct.name, (
SELECT image.filename
FROM image
WHERE similarProduct.id = image.product_id
LIMIT 1
) AS image
FROM auction originalAuction
JOIN auction similarAuction ON originalAuction.id != similarAuction.id
JOIN product originalProduct ON originalAuction.product_id =
originalProduct.id
JOIN product similarProduct ON similarAuction.product_id = similarProduct.id
WHERE similarAuction.type = originalAuction.type
AND similarProduct.type && originalProduct.type
AND originalAuction.id =?
LIMIT 8 ;
-->

<!--
SQL306 Get the answer to a given question R
SELECT \* FROM answer WHERE question_id = ?;
-->

<!--
SQL307 Create an answer 
INSERT INTO answer (DATE, message, question_id, user_id) VALUES (now(), ?,
?, ?);
-->

<!--
SQL311 Get number of active auctions. 
SELECT COUNT(*) FROM auction WHERE now() < end_date;

SQL312 Get total value of active auctions. 
SELECT SUM(curr_bid) FROM auction WHERE now() < end_date;

SQL313 Get top ten ranking users. 
SELECT "user".id, "user".username, "user".rating
FROM "user"
WHERE "user".rating IS NOT NULL
ORDER BY rating DESC
LIMIT 10 ;

SQL314 Get most popular auctions. 
SELECT auction.id, product.name AS product_name, "user".username,
"user".rating AS user_rating,
auction.curr_bid, auction.end_date, "user".id AS user_id
FROM bid
INNER JOIN auction ON bid.auction_id = auction.id
INNER JOIN product ON auction.product_id = product.id
INNER JOIN "user" ON auction.user_id = "user".id
WHERE now() < auction.end_date
GROUP BY auction.id, product.name, "user".username, "user".rating,
auction.curr_bid, auction.end_date, "user".id
ORDER BY COUNT(*) DESC
LIMIT 15 ;
-->

<!--
SQL317 Get the auctions in the watchlist of a certain user. 
SELECT product.name,
(SELECT image.filename
FROM image
WHERE image.product_id = product.id
LIMIT 1 ) AS image,
product.description, auction.curr_bid, now() - auction.end_date AS
remaining_time,
seller.username AS seller_username, seller.rating
FROM watchlist
JOIN auction ON watchlist.auction_id = auction.id
JOIN product ON auction.product_id = product.id
JOIN "user" own ON watchlist.user_id = own.id
JOIN "user" seller ON auction.user_id = seller.id
WHERE own.id = ?;

SQL320 Add auction to watchlist. R
INSERT INTO watchlist (auction_id, user_id, notifications, DATE)
VALUES (?, ?, ?, ?);

SQL321 Toggle notification option of an auction in the user's watchlist.R
UPDATE watchlist
SET notifications = NOT notifications
WHERE auction_id =?
AND user_id = ?;

SQL322 Remove auction from watchlist.
DELETE FROM watchlist
WHERE auction_id =?
AND user_id = ?;
-->


### 1.4 <a name="M04">M04: Administração</a>

| Acesso | Descrição |
| ------ | --------- |
| [SQL401](#SQL401) | Obter Denuncias  |
| [SQL402](#SQL402) | Obter banidos |
| [SQL403](#SQL403)       |   Obter Membros    |
| [SQL404](#SQL404)       |  Obter dados de uma Denuncia |
| [SQL405](#SQL405)       | Adicionar um novo administrador |
| [SQL406](#SQL406)       | Banir Membro  |
| [SQL407](#SQL407)       | Remover Comentário |
| [SQL408](#SQL408)       | Remover Produto |


| **<a name="SQL401">SQL401</a>**  | Obter Denuncias |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R401](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R401) |
| Código SQL completo | SELECT * FROM report LEFT JOIN report_authenticated ON id=report_authenticated.id_report LEFT JOIN report_comment ON id=report_comment.id_report LEFT JOIN report_product ON id=report_product.id_report ORDER BY date_report DESC; |

| **<a name="SQL402">SQL402</a>**  | Obter Banidos |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R402](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R402) |
| Código SQL completo | SELECT username, email FROM authenticated WHERE state_user = 'suspended' OR state_user = 'banned'; |

| **<a name="SQL403">SQL403</a>**  | Obter membros |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R404](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R404) |
| Código SQL completo | SELECT username, email FROM authenticated JOIN admin ON id=id_admin where username = $username AND id != $id; |


| **<a name="SQL404">SQL404</a>**  | Obter dados de uma denúncia |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R405](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R405) |
| Código SQL completo | SELECT * FROM report LEFT JOIN report_authenticated ON id=report_authenticated.id_report LEFT JOIN report_comment ON id=report_comment.id_report LEFT JOIN report_product ON id=report_product.id_report WHERE id = $id; |


| **<a name="SQL405">SQL405</a>**  | Adicionar um novo Administrador |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R406](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R406) |
| Código SQL completo | INSERT INTO admin (username, email, name, password, date_register) VALUES ($username, $email, $name, $password, current_timestamp); |

| **<a name="SQL406">SQL406</a>**  | Banir Membro |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R407](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R407) |
| Código SQL completo | UPDATE authenticated SET user_type = 'banned' WHERE id = $id; |

| **<a name="SQL407">SQL407</a>**  | Remover Comentário |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R408](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R408) |
| Código SQL completo | DELETE FROM comments WHERE id_comment = $id_comment; |

| **<a name="SQL408">SQL408</a>**  | Remover Produto |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R409](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R409) |
| Código SQL completo | UPDATE product SET state_product = 'inactive' WHERE id_product = $id_product; |


<!--
SQL406 Get all auctions 
SELECT \* FROM auction ORDER BY id ASC;

SQL408 Creates a new notification associated to an user
INSERT INTO notification (message, TYPE, is_new, user_id, DATE) VALUES (?,
?, ?, ?, now()))
-->

1.5 <a name="M05">M05: Publico em Geral</a>

| Acesso | Descrição |
| ------ | --------- |
| [SQL501](#SQL501) | Obter os 10 produtos mais recentes % 4 = 1 |
| [SQL502](#SQL502) | Obter os 10 produtos mais recentes % 4 = 2 |
| [SQL503](#SQL503) | Obter os 10 produtos mais recentes % 4 = 3 |
| [SQL504](#SQL504) | Obter os 10 produtos mais recentes % 4 = 4 |


| **<a name="SQL501">SQL501</a>**  | Obter os 10 produtos mais recentes % 4 = 1 |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R501](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R501) |
| Código SQL completo | SELECT id_product, username, name_product, product.photo, highest_value, final_value FROM product JOIN authenticated ON product.id_owner = authenticated.id LEFT JOIN auction on id_auction = id_product LEFT JOIN buy_it_now ON id_product = id_buy WHERE state_product = 'active' AND (current_timestamp<buy_it_now.date_end OR current_timestamp<auction.date_end_auction) AND (id_product-1) % 4 = 0 LIMIT 10; |

| **<a name="SQL502">SQL502</a>**  | Obter os 10 produtos mais recentes % 4 = 2 |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R501](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R501) |
| Código SQL completo | SELECT id_product, username, name_product, product.photo, highest_value, final_value FROM product JOIN authenticated ON product.id_owner = authenticated.id LEFT JOIN auction on id_auction = id_product LEFT JOIN buy_it_now ON id_product = id_buy WHERE state_product = 'active' AND (current_timestamp<buy_it_now.date_end OR current_timestamp<auction.date_end_auction) AND (id_product-1) % 4 = 1 LIMIT 10; |

| **<a name="SQL503">SQL503</a>**  | Obter os 10 produtos mais recentes % 4 = 3 |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R501](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R501) |
| Código SQL completo | SELECT id_product, username, name_product, product.photo, highest_value, final_value FROM product JOIN authenticated ON product.id_owner = authenticated.id LEFT JOIN auction on id_auction = id_product LEFT JOIN buy_it_now ON id_product = id_buy WHERE state_product = 'active' AND (current_timestamp<buy_it_now.date_end OR current_timestamp<auction.date_end_auction) AND (id_product-1) % 4 = 2 LIMIT 10; |

| **<a name="SQL504">SQL504</a>**  | Obter os 10 produtos mais recentes % 4 = 4 |
| ------------- | ------------------------------------------- |
| Recurso _web_ | [R501](https://git.fe.up.pt/lbaw/lbaw18/lbaw1856/wikis/a7#R501) |
| Código SQL completo | SELECT id_product, username, name_product, product.photo, highest_value, final_value FROM product JOIN authenticated ON product.id_owner = authenticated.id LEFT JOIN auction on id_auction = id_product LEFT JOIN buy_it_now ON id_product = id_buy WHERE state_product = 'active' AND (current_timestamp<buy_it_now.date_end OR current_timestamp<auction.date_end_auction) AND (id_product-1) % 4 = 3 LIMIT 10; | 


## 2. Transações
 
> Transações necessárias para garantir a integridade dos dados.






| T01 | Ao obter pesquisas (para garantir que nada é alterado durante retrieval de dados) |
| --------------- | ----------------------------------- |
| Justificação | Ao obter pesquisas (para garantir que nada é alterado durante retrieval de dados) |
| Nível de isolamento | SERIALIZABLE READ ONLY |
| Código SQL Completo | 
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY
[TODO]
COMMIT; 
``` 





| T02 | criar novo produto leilão |
| --------------- | ----------------------------------- |
| Justificação | Para manter a consistência, é necessário usar uma transação para garantir que todo o código seja executado sem erros. Se ocorrer um erro, um ROLLBACK será emitido (quando a inserção de um livro falhar, por exemplo). O nível de isolamento é Repeatable Read, porque, do contrário, uma atualização de work_id_seq poderia acontecer, devido a uma inserção no trabalho da tabela comprometida por uma transação simultânea e, como resultado, dados inconsistentes seriam armazenados. |
| Nível de isolamento | REPEATABLE READ |
| Código SQL Completo | |
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
WITH produto AS INSERT INTO product (name, category, foto, is_new, description, sale_type, date_placement) VALUES ($name, $category, $foto, $is_new, $description, $sale_type, current_timestamp) RETURNING id_product)
INSERT INTO auction VALUES (produto.id_product, $date_end, $bidding_base, $bidding_base);
COMMIT; 
```



| T03 | criar novo produto _buy_it_now_ |
| --------------- | ----------------------------------- |
| Justificação | Para manter a consistência, é necessário usar uma transação para garantir que todo o código seja executado sem erros. Se ocorrer um erro, um ROLLBACK será emitido (quando a inserção de um livro falhar, por exemplo). O nível de isolamento é Repeatable Read, porque, do contrário, uma atualização de work_id_seq poderia acontecer, devido a uma inserção no trabalho da tabela comprometida por uma transação simultânea e, como resultado, dados inconsistentes seriam armazenados. |
| Nível de isolamento | REPEATABLE READ |
| Código SQL Completo | |
```sql
 BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
 WITH produto AS INSERT INTO product (name, category, foto, is_new, description, sale_type, date_placement) VALUES ($name, $category, $foto, $is_new, $description, $sale_type, current_timestamp) RETURNING id_product)
INSERT INTO buy_it_now VALUES (produto.id_product, $date_end, $final_value); 
COMMIT; 
 ```




| T04 | denunciar um produto |
| --------------- | ----------------------------------- |
| Justificação | Para manter a consistência, é necessário usar uma transação para garantir que todo o código seja executado sem erros. Se ocorrer um erro, um ROLLBACK será emitido (quando a inserção de um livro falhar, por exemplo). O nível de isolamento é Repeatable Read, porque, do contrário, uma atualização de work_id_seq poderia acontecer, devido a uma inserção no trabalho da tabela comprometida por uma transação simultânea e, como resultado, dados inconsistentes seriam armazenados. |
| Nível de isolamento | REPEATABLE READ |
| Código SQL Completo | |
```sql
 BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
WITH produto AS (INSERT INTO report (state_report, date_report, reason, text_report) VALUES ('assume',  current_timestamp, "", $text_report) returning id)
INSERT INTO report_product (id_product,id_reporter,id_report) VALUES ($id_product, $id_reporter, (select id from produto));
COMMIT; 
 ```
 


| T05 | denunciar um comentário |
| --------------- | ----------------------------------- |
| Justificação | Para manter a consistência, é necessário usar uma transação para garantir que todo o código seja executado sem erros. Se ocorrer um erro, um ROLLBACK será emitido (quando a inserção de um livro falhar, por exemplo). O nível de isolamento é Repeatable Read, porque, do contrário, uma atualização de work_id_seq poderia acontecer, devido a uma inserção no trabalho da tabela comprometida por uma transação simultânea e, como resultado, dados inconsistentes seriam armazenados. |
| Nível de isolamento | REPEATABLE READ |
| Código SQL Completo | |
```sql
 BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
WITH produto AS (INSERT INTO report (state_report, date_report, reason, text_report) VALUES ('assume',  current_timestamp, "", $text_report) returning id)
INSERT INTO report_comment (id_comment,id_reporter,id_report) VALUES ($id_comment, $id_reporter, (select id from produto));
COMMIT; 
 ```



| T06 | denunciar _authenticated_ |
| --------------- | ----------------------------------- |
| Justificação | Para manter a consistência, é necessário usar uma transação para garantir que todo o código seja executado sem erros. Se ocorrer um erro, um ROLLBACK será emitido (quando a inserção de um livro falhar, por exemplo). O nível de isolamento é Repeatable Read, porque, do contrário, uma atualização de work_id_seq poderia acontecer, devido a uma inserção no trabalho da tabela comprometida por uma transação simultânea e, como resultado, dados inconsistentes seriam armazenados. |
| Nível de isolamento | REPEATABLE READ |
| Código SQL Completo | |
```sql
 BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
WITH produto AS (INSERT INTO report (state_report, date_report, reason, text_report) VALUES ('assume',  current_timestamp, "", $text_report) returning id)
INSERT INTO report_authenticated (id_user,id_reporter,id_report) VALUES ($id, $id_reporter, (select id from produto));
COMMIT; 
 ```




| T07 | Editar um produto de leilão |
| --------------- | ----------------------------------- |
| Justificação | em cadeia. [TODO] |
| Nível de isolamento | REPEATABLE READ[TODO] |
| Código SQL Completo | |
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
UPDATE product SET name = $name, category = $category, foto = $foto, is_new = $is_new, description = $description, sale_type = $sale_type WHERE id_product = $id_product; UPDATE auction SET date_end = $date_end WHERE id_auction = $id_product;
COMMIT; 
 ```


| T08 | Editar produto de _buy_it_now_ |
| --------------- | ----------------------------------- |
| Justificação | em cadeia. [TODO] |
| Nível de isolamento | REPEATABLE READ[TODO] |
| Código SQL Completo | |
```sql
 BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
UPDATE product SET name = $name, category = $category, foto = $foto, is_new = $is_new, description = $description, sale_type = $sale_type WHERE id_product = $id_product; UPDATE buy_it_now SET date_end = $date_end, final_value = $final_value WHERE id_buy = $id_product;
COMMIT; 
 ```
 

| T09 | Licitar (garantir que a licitação é com os dados que se viu) [TODO] |
| --------------- | ----------------------------------- |
| Justificação | Licitar (garantir que a licitação é com os dados que se viu) [TODO] |
| Nível de isolamento | [TODO] |
| Código SQL Completo | |
```sql
 BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
[TODO]
Licitar (garantir que a licitação é com os dados que se viu)
COMMIT; 
 ```



| T10 | comprar (garantir que compra é com os dados que se viu) [TODO] |
| --------------- | ----------------------------------- |
| Justificação | comprar (garantir que compra é com os dados que se viu) [TODO] |
| Nível de isolamento | [TODO] |
| Código SQL Completo | |
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
[TODO]
comprar (garantir que compra é com os dados que se viu)
COMMIT;
  ```


| T11 | 
denunciar (garantir que a denuncia é sobre o que se viu) [TODO] FAZER NAS TRANSACTIONS DOS INSERTS NOS REPORTS |
| --------------- | ----------------------------------- |
| Justificação | 
denunciar (garantir que a denuncia é sobre o que se viu) [TODO] |
| Nível de isolamento | [TODO] |
| Código SQL Completo | |
```sql
 BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
[TODO]
denunciar (garantir que a denuncia é sobre o que se viu)
COMMIT; 
 ```
</tr></td></table> 



<!--


Se só selects => read only

Se quisermos garantir dois selects seguidos acedem ao mesmo => serializable

se quisermos garantir insert produto e insert auction => REPEATABLE READ

-->

<!--

T01 Bid transaction


Isolation Level


REPEATABLE READ, because only sees data committed before the transaction
began, ensuring that the balance of the user is equal to the value initially read at
the beginning of the INSERT and UPDATE statements. In fact, the first SELECT locks
the amount attribute of table user until the end of the transaction.
Web Resource R
BEGIN TRANSACTION ;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ ;


SELECT amount AS balance FROM "user" WHERE "user".id = :user_id;


-- if balance >= amount_bid


INSERT INTO bid (amount, DATE, user_id, auction_id)
VALUES (:amount_bid, now(), :user_id, :auction_id);


UPDATE "user"
SET amount = amount - :amount_bid
WHERE "user".id = :user_id;
-- send success message


-- else
-- send error message


COMMIT;
T02 Get information of auctions in homepage


Isolation Level


SERIALIZABLE READ ONLY, because in the middle of the transaction the insertion of
new rows in the auction table can occur, which will lead to incompatibilities between
the SELECTS, resulting in a Phantom Read (If a new auction is entered between the
1st SELECT and the 2nd SELECT, the 2nd SELECT will read more auctions than the
first one). It is READ ONLY because only use SELECT instructions.
Web Resource R



#### BEGIN TRANSACTION ;

#### SET TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY ;


-- get total active auctions
SELECT COUNT(*)
FROM auction
WHERE now() < end_date;


-- get total value of all auctions
SELECT SUM(curr_bid)
FROM auction
WHERE now() < end_date;


-- get most popular auctions of site (more popular = more bids)
SELECT auction.id, product.name AS product_name, "user".username,
"user".rating AS user_rating,
auction.curr_bid, auction.end_date, "user".id AS user_id
FROM bid
INNER JOIN auction ON bid.auction_id = auction.id
INNER JOIN product ON auction.product_id = product.id
INNER JOIN "user" ON auction.user_id = "user".id
WHERE now() < auction.end_date
GROUP BY auction.id, product.name, "user".username, "user".rating,
auction.curr_bid, auction.end_date, "user".id
ORDER BY COUNT(*) DESC
LIMIT 15 ;


COMMIT;
T03 Get auction main information


Isolation Level


REPEATABLE READ READ ONLY, because, in the middle of the transaction, the
update of the specified auction row can occur, which will lead to incompatibilities
between the SELECTS, resulting in a Nonrepeatable Read. It is READ ONLY because
it only uses SELECT instructions.
Web Resource R




#### BEGIN TRANSACTION ;

#### SET TRANSACTION ISOLATION LEVEL REPEATABLE READ READ ONLY ;

#### SELECT \*


FROM auction
WHERE auction.id = ?;


SELECT product.*
FROM product
JOIN auction ON auction.product_id = product.id
WHERE auction.id = ?;


SELECT "user".*
FROM "user"
INNER JOIN auction ON "user".id = auction.user_id
WHERE auction.id = ?;


SELECT image.*
FROM image
JOIN product ON image.product_id = product.id
JOIN auction ON product.id = auction.product_id
WHERE auction.id = ?;


COMMIT;
T04 Post answer and send notification to user


Isolation Level


REPEATABLE READ, because it prevents the update of
notifications options in the middle of transaction.
Web Resource R




#### BEGIN TRANSACTION;

#### SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;


-- Insert answer.
INSERT INTO answer(DATE, message, question_id, user_id, auction_id)
VALUES(now(), :message, :question_id, :user_id, :auction_id);


-- Get question user id.
SELECT user_id
FROM question
WHERE id = :question_id;


-- Get user notification enabled/disabled setting.
SELECT notifications
FROM watchlist
WHERE user_id = :user_id
AND auction_id = :auction_id;


-- if notifications are enabled


-- Insert notification.
INSERT INTO notification(message, TYPE, user_id, is_new, DATE)
VALUES('Your question at the auction was answered!',
'Answer',
:user_id,
TRUE,
now());


-- send success message with notification.


-- else


--send success message without notification.

#### COMMIT;


T05 Get questions and respective answers, if they exist


Isolation Level


REPEATABLE READ READ ONLY, because, in the middle of the transaction, the
update of retrieved data can occur, which will lead to incompatibilities between the
SELECTS, resulting in a Nonrepeatable Read. It is READ ONLY because it only uses
SELECT instructions.
Web Resource R
BEGIN TRANSACTION ;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ READ ONLY ;


SELECT question.*, "user".username
FROM question
INNER JOIN "user" ON "user".id = question.user_id
WHERE auction_id = ?;


-- foreach question
SELECT \* FROM answer WHERE question_id = ?;

#### COMMIT;

-->






<!--
## Histórico de revisões

Alterações efetuadas à primeira submissão:
 1. Melhoramento da consistência de linguagem.
 2. 
 3. 
-->

***
GROUP1856, 30/04/2019
 
* Luis Ricardo Marques Oliveira, up201607946@fe.up.pt (editor)
* Tiago Augusto Pacheco Ludovico Pinto de Barros, up201502847@fe.up.pt
* Henrique Miguel Bastos Gonçalves, up201608320@fe.up.pt
* Ricardo Manuel Gonçalves da Silva, up201607780@fe.up.pt